<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подбор состава армии</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 8px; text-align: center; }
        th { background-color: #f4f4f4; }
        .output { margin-top: 20px; font-size: 1.2em; }
        .unit-selector { margin-top: 10px; }
        .unit-row { margin-bottom: 10px; }
        .btn { padding: 5px 15px; cursor: pointer; }
        .btn-remove { background-color: red; color: white; }
        .btn-add { margin-bottom: 10px; background-color: green; color: white; }
        .unit-lists { display: flex; flex-direction: row; gap: 20px; }
    </style>
</head>
<body>

    <h1>Подбор состава армии</h1>

    <label for="leadership">Введите общее значение лидерства:</label>
    <input type="number" id="leadership" name="leadership" min="1" placeholder="Введите число">
    <button onclick="calculateArmy()">Рассчитать</button>

    <div class="unit-selector">
        <h3>Добавить юнита</h3>
        <div class="unit-lists">
            <div class="guard-list">
                <h4>Гвардейцы</h4>                
                <div id="guardList"></div>
                <button class="btn btn-add" onclick="addGuard()">Добавить Гвардейца</button>
            </div>
            <div class="specialist-list">
                <h4>Специалисты</h4>                
                <div id="specialistList"></div>
                <button class="btn btn-add" onclick="addSpecialist()">Добавить Специалиста</button>
            </div>
        </div>
    </div>

    <div class="output" id="output"></div>

    <table id="armyTable" style="display:none;">
        <thead>
            <tr>
                <th>Тип юнита</th>
                <th>Количество</th>
                <th>Общее HP</th>
                <th>Общая сила</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // Данные о юнитах
        const UNIT_STATS = {
            "Archer": {
                "leadership": 1,
                "strength_by_level": { 1: 50, 2: 90, 3: 160, 4: 290, 5: 520, 6: 940, 7: 1700, 8: 3060, 9: 5510 }
            },
            "Spearman": {
                "leadership": 1,
                "strength_by_level": { 1: 50, 2: 90, 3: 160, 4: 290, 5: 520, 6: 940, 7: 1700, 8: 3060, 9: 5510 }
            },
            "Rider": {
                "leadership": 2,
                "strength_by_level": { 1: 100, 2: 180, 3: 320, 4: 580, 5: 1050, 6: 1900, 7: 3400, 8: 6120, 9: 11020 }
            },
            "BattleGriffin": {
                "leadership": 20,
                "strength_by_level": { 5: 10000, 6: 19000, 7: 34000, 8: 61200, 9: 110200 }
            },
            "Deadshot": {
                "leadership": 1,
                "strength_by_level": { 5: 520, 6: 940, 7: 1700, 8: 3060, 9: 5510 }
            },
            "Swordsman": {
                "leadership": 1,
                "strength_by_level": { 1: 50, 2: 90, 3: 160, 4: 290, 5: 520, 6: 940, 7: 1700, 8: 3060, 9: 5510 }
            },
            "LionRider": {
                "leadership": 2,
                "strength_by_level": { 5: 1050, 6: 1900, 7: 3400 }
            },                        
            "Vulture": {
                "leadership": 2,
                "strength_by_level": { 5: 520, 6: 940, 7: 1700 }
            },
            "RoyalLion": {
                "leadership": 2,
                "strength_by_level": { 1: 61200, 2: 110200 }
            },

        };

        // Класс для юнита
        class Unit {
            constructor(unitType, level) {
                this.unitType = unitType;
                this.level = level;
                this.name = `${unitType}(${level})`;
                this.leadership = UNIT_STATS[unitType].leadership;
                this.strength = UNIT_STATS[unitType].strength_by_level[level] || 0;
                this.hp = this.strength * 3;
                this.hpPerLead = Math.floor(this.hp / this.leadership);
                this.count = 0;  // Расчитываем позже
            }
        }

        // Функция для добавления нового гвардейца
        function addGuard() {
            const guardList = document.getElementById('guardList');
            const newUnitRow = document.createElement('div');
            newUnitRow.classList.add('unit-row');
            newUnitRow.innerHTML = `
                <select class="unit-type" onchange="updateLevelOptions(this)">
                    <option value="Archer">Лучник</option>
                    <option value="Spearman">Копейщик</option>
                    <option value="Rider">Наездник</option>
                    <option value="BattleGriffin">Боевой Грифон</option>
                </select>
                <select class="unit-level">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
                <button class="btn btn-remove" onclick="removeUnit(this)">Удалить</button>
            `;
            guardList.appendChild(newUnitRow);
            updateLevelOptions(newUnitRow.querySelector('.unit-type')); // Обновляем уровни при добавлении
        }

        // Функция для добавления нового специалиста
        function addSpecialist() {
            const specialistList = document.getElementById('specialistList');
            const newUnitRow = document.createElement('div');
            newUnitRow.classList.add('unit-row');
            newUnitRow.innerHTML = `
                <select class="unit-type" onchange="updateLevelOptions(this)">
                    <option value="Swordsman">Мечник</option>
                    <option value="Deadshot">Элитный арбалетчик</option>
                    <option value="LionRider">Всадник на льве</option>
                    <option value="Vulture">Стервятник</option>
                    <option value="RoyalLion">Королевский лев</option>
                </select>
                <select class="unit-level">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                </select>
                <button class="btn btn-remove" onclick="removeUnit(this)">Удалить</button>
            `;
            specialistList.appendChild(newUnitRow);
            updateLevelOptions(newUnitRow.querySelector('.unit-type')); // Обновляем уровни при добавлении
        }

        // Функция для обновления доступных уровней
        function updateLevelOptions(selectElement) {
            const unitType = selectElement.value;
            const levelSelect = selectElement.closest('.unit-row').querySelector('.unit-level');

            // Сбрасываем все опции
            levelSelect.innerHTML = '';

            // Добавляем уровни в зависимости от типа юнита
            if (unitType === "BattleGriffin" || unitType === "LionRider" || unitType === "Vulture" || unitType === "Deadshot") {
                for (let i = 5; i <= 9; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    levelSelect.appendChild(option);
                }
            } else if (unitType === "RoyalLion") {
                for (let i = 1; i <= 2; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    levelSelect.appendChild(option);
                }
            } else {
                for (let i = 1; i <= 9; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    levelSelect.appendChild(option);
                }
            }
        }

        // Функция для удаления юнита
        function removeUnit(button) {
            const unitRow = button.closest('.unit-row');
            unitRow.remove();
        }

        // Функция для расчёта состава армии
        function calculateArmy() {
            const leadership = parseInt(document.getElementById('leadership').value);
            if (isNaN(leadership) || leadership <= 0) {
                alert("Пожалуйста, введите корректное значение лидерства.");
                return;
            }

            const units = [];

            // Получаем все юниты из списка гвардейцев
            const guardRows = document.querySelectorAll('#guardList .unit-row');
            guardRows.forEach(row => {
                const unitType = row.querySelector('.unit-type').value;
                const unitLevel = parseInt(row.querySelector('.unit-level').value);
                units.push(new Unit(unitType, unitLevel));
            });

            // Получаем все юниты из списка специалистов
            const specialistRows = document.querySelectorAll('#specialistList .unit-row');
            specialistRows.forEach(row => {
                const unitType = row.querySelector('.unit-type').value;
                const unitLevel = parseInt(row.querySelector('.unit-level').value);
                units.push(new Unit(unitType, unitLevel));
            });

            // Выполняем расчёты
            const army = getUnitCounts(leadership, units);

            // Выводим результаты
            displayResults(army, leadership);
        }

        // Функция для вычисления количества юнитов
        function getUnitCounts(totalLeadership, units, step = 0, recursionDepth = 0) {
            const numUnits = units.length;
            const leadershipPerUnit = Math.floor(totalLeadership / numUnits);
            const avgHpPerLead = Math.floor(units.reduce((sum, unit) => sum + unit.hpPerLead, 0) / numUnits) - step;
            const squadHp = avgHpPerLead * leadershipPerUnit;

            let requiredLeadership = 0;

            // Подсчёт количества юнитов
            units.forEach(unit => {
                unit.count = Math.floor(squadHp / unit.hp);
                requiredLeadership += unit.count * unit.leadership;
            });

            // Если лидерства не хватает, пытаемся перерасчитать
            if (requiredLeadership > totalLeadership) {
                return getUnitCounts(totalLeadership, units, step + 10, recursionDepth + 1);
            }

            return units;
        }

        // Функция для отображения результатов
        function displayResults(units, leadership) {
            const output = document.getElementById('output');
            const armyTable = document.getElementById('armyTable');
            const tbody = armyTable.querySelector('tbody');

            // Очищаем таблицу перед новым выводом
            tbody.innerHTML = '';

            let totalRequiredLeadership = 0;
            let totalWarriors = 0;

            units.forEach(unit => {
                const totalHp = unit.count * unit.hp;
                const totalStrength = unit.count * unit.strength;

                // Добавляем строку в таблицу
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${unit.name}</td>
                    <td>${unit.count}</td>
                    <td>${totalHp}</td>
                    <td>${totalStrength}</td>
                `;
                tbody.appendChild(row);

                totalRequiredLeadership += unit.count * unit.leadership;
                totalWarriors += unit.count;
            });

            // Показываем таблицу
            armyTable.style.display = 'table';

            output.innerHTML = `
                <p>Среднее количество хп на отряд: ${Math.floor(units.reduce((sum, unit) => sum + unit.hpPerLead, 0) / units.length)}</p>
                <p>Общее количество бойцов: ${totalWarriors}</p>
                <p>Общее потребление лидерства: ${totalRequiredLeadership}</p>
                <p>Ожидаемое здоровье на отряд: ${Math.floor(totalRequiredLeadership / units.length)}</p>
            `;
        }
    </script>
</body>
</html>

